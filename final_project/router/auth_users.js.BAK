const express = require('express');
const jwt = require('jsonwebtoken');
let books = require("./booksdb.js");
const regd_users = express.Router();

let users = [];


const isValid = (username) => {
  // Check if any user with the same username exists in the users array
  return users.some((user) => user.username === username);
}

// Check if the user with the given username and password exists
const authenticatedUser = (username, password) => {
    // Filter the users array for any user with the same username and password

    if (!isValid(username)) return false;
    
    const authenticated = users.some((user) => user.username === username && user.password === password);

    if (authenticated) return true;
    else return false;
    
}


//only registered users can login
// Login endpoint
regd_users.post("/login", (req, res) => {
    const username = req.body.username;
    const password = req.body.password;
    // Check if username or password is missing
    if (!username || !password) {
        return res.status(404).json({ message: "Error logging in.  Username or password missing." });
    }
    // Authenticate user
    if (authenticatedUser(username, password)) {
        // Generate JWT access token
        let accessToken = jwt.sign({
            data: password
        }, 'access', { expiresIn: 60 * 180 });
        // Store access token and username in session
        req.session.authorization = {
            accessToken, username
        }
        return res.status(200).send(`Customer successfully logged in - username ${username}`);
    } else {
        return res.status(208).json({ message: `${users} ::::: Invalid Login. Check username and password: username: ${username}, password: ${password}` });
    }
});


// Add a book review
regd_users.put('/auth/review/:isbn', (req, res) => {
  const isbn = req.params.isbn;
  let bookFound;

  for (const key in books) { // Iterate through the books array
    if (key === isbn.toString()) { // Check if we've found the desired ISBN
      bookFound = true; // Mark it as found

      if (!books[key].reviews || !Object.keys(books[key].reviews).length > 0) {
        books[isbn].reviews = { username: req.body.username, review: req.body.review };
      } else {
        const currentReviews = Object.values(books[key].reviews);
        for (let i = 0; i < currentReviews.length; i++) {
          if (!currentReviews[i]) continue;
          console.log(`Review found. Replacing with new one.`);
          books[isbn].reviews = { username: req.body.username, review: req.body.review };
        }
      }

      return res.status(200).json({ message: `Review added successfully for ISBN ${isbn}` });
    }
  }

  if (!bookFound) {
    console.log(`Book not found - isbn ${isbn}`);
    return res.json({ message: 'Book not found' });
  }
});






regd_users.delete("/auth/delete/:isbn", (req, res) => {
    const isbn = parseInt(req.params.isbn);
    let bookFound = false;
  
    for (const key in books) { 
      if (key === isbn.toString()) { 
        bookFound = true;
        
        Object.keys(books[key].reviews).forEach(reviewId => {
          if (books[key].reviews[reviewId].username === req.body.username) {
            delete books[key].reviews[reviewId]; // Delete the review
            return res.status(200).json({ message: `Review deleted successfully for ISBN ${req.params.isbn}` });
          }
        });
  
        if (!Object.keys(books[key].reviews).length > 0) { 
          console.log(`No reviews left for this book.`);
         } else {
          console.log(`Reviews still exist for this book.`);
         }
  
      if (!bookFound) { // Check if the book was not found
        console.log(`Book not found - isbn ${req.params.isbn}`);
        return res.json({ message: 'Book not found' });
       }
     }
  }});


module.exports.authenticated = regd_users;
module.exports.isValid = isValid;
module.exports.users = users;
